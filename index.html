<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter Archive Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <style>
        /* --- テーマ変数定義 --- */
        :root {
            /* ライトモード (デフォルト) */
            --bg-color: #f4f5f7;
            --main-text: #0f1419;
            --sub-text: #536471;
            --border-color: #cccccc;
            --accent-color: #1d9bf0;
            --hover-bg: rgba(15, 20, 25, 0.1);
            --card-bg: #f4f5f7;
            --header-bg: rgba(244, 245, 247, 0.85);
            --poll-bar-bg: #cfd9de40;
            --poll-bar-fill: #cfd9de;
            --logo-color: #1d9bf0;
            --tweet-hover: rgba(0, 0, 0, 0.03);
            --drop-active: #f0f7ff;
            --drop-border: #1d9bf0;
        }

        [data-theme="dark"] {
            /* ダークモード (Twitter Dim) */
            --bg-color: #15202b;
            --main-text: #ffffff;
            --sub-text: #8899a6;
            --border-color: #38444d;
            --accent-color: #1d9bf0;
            --hover-bg: rgba(255, 255, 255, 0.1);
            --card-bg: #15202b;
            --header-bg: rgba(21, 32, 43, 0.85);
            --poll-bar-bg: #38444d;
            --poll-bar-fill: rgba(29, 155, 240, 0.5);
            --logo-color: #ffffff;
            --tweet-hover: rgba(255, 255, 255, 0.03);
            --drop-active: rgba(29, 155, 240, 0.1);
            --drop-border: #1d9bf0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--main-text);
            overflow-y: scroll;
            transition: background-color 0.2s, color 0.2s;
        }

        .app-layout {
            display: flex;
            justify-content: center;
            min-height: 100vh;
            max-width: 1250px;
            margin: 0 auto;
        }

        /* 左サイドバー */
        .sidebar {
            width: 275px;
            padding: 0 12px;
            position: sticky;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            box-sizing: border-box;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 30px;
            transition: 0.2s;
            margin-bottom: 4px;
            color: var(--main-text);
            text-decoration: none;
            font-size: 20px;
        }

        .nav-item:hover {
            background-color: var(--hover-bg);
        }

        .nav-item svg {
            width: 26.25px;
            height: 26.25px;
            margin-right: 20px;
            fill: currentColor;
        }

        .nav-item span {
            margin-right: 15px;
        }

        .nav-item.active {
            font-weight: bold;
        }

        /* ロゴ */
        .logo-container {
            padding: 12px;
            width: fit-content;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 2px;
        }

        .logo-container:hover {
            background-color: var(--hover-bg);
        }

        .logo {
            width: 30px;
            height: 30px;
            fill: var(--logo-color);
        }

        /* アカウントリスト */
        .account-section {
            margin-top: auto;
            margin-bottom: 20px;
            width: 100%;
        }

        .account-item {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 30px;
            transition: 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        .account-item:hover {
            background-color: var(--hover-bg);
        }

        .account-item.active {
            background-color: var(--hover-bg);
        }

        .account-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            border: 1px solid var(--border-color);
        }

        .account-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .account-name {
            font-weight: bold;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--main-text);
        }

        .account-id {
            color: var(--sub-text);
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* メインコンテンツ */
        .main-content {
            width: 600px;
            border-right: 1px solid var(--border-color);
            min-height: 100vh;
            flex-shrink: 0;
        }

        .upload-area {
            padding: 40px;
            text-align: center;
            margin-top: 50px;
        }

        .file-upload {
            background: var(--bg-color);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border: 2px dashed var(--border-color);
            cursor: pointer;
            transition: 0.2s;
        }

        .file-upload:hover {
            border-color: var(--drop-border);
            background: var(--drop-active);
        }

        .file-upload input {
            display: none;
        }

        /* ヘッダー */
        .feed-header {
            position: sticky;
            top: 0;
            background: var(--header-bg);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            padding: 0 16px;
            height: 53px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        /* ▼▼▼ 修正箇所: セレクタを .feed-header h2 に変更してマージン0を適用 ▼▼▼ */
        .feed-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--main-text);
        }

        .feed-subtitle {
            font-size: 13px;
            color: var(--sub-text);
        }

        /* プロフィール */
        .profile-card {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }

        .profile-banner {
            height: 200px;
            background-color: #cfd9de;
            margin: -16px -16px 0 -16px;
        }

        .profile-avatar-large {
            width: 134px;
            height: 134px;
            border-radius: 50%;
            border: 4px solid var(--bg-color);
            margin-top: -70px;
            margin-bottom: 12px;
            object-fit: cover;
            background: var(--bg-color);
            cursor: pointer;
            transition: 0.2s;
        }

        .profile-avatar-large:hover {
            filter: brightness(0.9);
        }

        /* フォロー・フォロワー表示 */
        .profile-stats { display: flex; gap: 20px; margin-top: 12px; font-size: 15px; }
        .stat-item { color: var(--sub-text); text-decoration: none; }
        .stat-item:hover { text-decoration: underline; }
        .stat-value { font-weight: bold; color: var(--main-text); }


        /* タブ */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            height: 53px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
            color: var(--sub-text);
        }

        .tab:hover {
            background-color: var(--hover-bg);
        }

        .tab.active {
            font-weight: bold;
            color: var(--main-text);
        }

        .tab-text {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .tab.active .tab-text::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--accent-color);
            border-radius: 9999px;
        }

        /* ツイートカード */
        .tweet {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: 0.2s;
            align-items: flex-start;
        }

        .tweet:hover {
            background-color: var(--tweet-hover);
        }

        .tweet-avatar {
            margin-right: 12px;
            flex-shrink: 0;
        }

        .tweet-avatar img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .tweet-avatar img:hover {
            filter: brightness(0.9);
        }

        .tweet-content {
            flex: 1;
            min-width: 0;
        }

        .tweet-header {
            display: flex;
            align-items: baseline;
            font-size: 15px;
            line-height: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-name-bold {
            font-weight: 700;
            color: var(--main-text);
            margin-right: 4px;
        }

        .user-id-gray {
            color: var(--sub-text);
            margin-right: 4px;
        }

        .tweet-date {
            color: var(--sub-text);
            text-decoration: none;
        }

        .tweet-date:hover {
            text-decoration: underline;
        }

        .dot-separator {
            color: var(--sub-text);
            margin-right: 4px;
        }

        .tweet-text {
            font-size: 15px;
            line-height: 20px;
            margin-top: 2px;
            margin-bottom: 12px;
            color: var(--main-text);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* --- メディア（画像・動画）グリッド --- */
        .media-grid {
            display: grid;
            width: fit-content; /* コンテンツ幅いっぱいに */
            max-width: 100%;
            border-radius: 16px;
            border: 1px solid var(--border-color); /* 画像の外枠 */
            overflow: hidden;
            background-color: none; /* 画像間の線の色（隙間から見える色） */
            gap: 2.5px; /* 画像の隙間を2.5pxあける */
            margin-top: 12px;
        }

        /* 1枚：隙間なし */
        .media-grid.cols-1 {
            grid-template-columns: 1fr;
            gap: 0; 
            border: 1px solid var(--border-color);
            background-color: transparent;
        }
        /* 2枚：横並び */
        .media-grid.cols-2 {
            grid-template-columns: 1fr 1fr;
            aspect-ratio: 16/9;
        }
        /* 3枚：左大、右2枚 */
        .media-grid.cols-3 {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            aspect-ratio: 16/9;
        }
        .media-grid.cols-3 > :first-child {
            grid-row: 1 / 3; /* 1枚目は2行ぶち抜き */
        }
        /* 4枚：2x2 */
        .media-grid.cols-4 {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            aspect-ratio: 16/9;
        }

        .media-grid img, .media-grid video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        /* 1枚のときはアスペクト比を維持しつつ最大高さを制限 */
        .media-grid.cols-1 img, .media-grid.cols-1 video {
            max-height: 550px;
            object-fit: contain; /* 元の比率で見せる */
            background-color: none; /* 余白は背景透過 */
            object-position: left top; /* 左上寄せ */
        }
        /* 3枚以上の時は画像を16:9でトリミング*/
        .media-grid.cols-3 img, .media-grid.cols-3 video,
        .media-grid.cols-4 img, .media-grid.cols-4 video {
            aspect-ratio: 16/9; /* トリミング */
        }

        /* 投票 */
        .poll-container {
            margin-top: 12px;
        }

        .poll-option {
            margin-bottom: 8px;
            position: relative;
        }

        .poll-bar-bg {
            height: 30px;
            background-color: var(--poll-bar-bg);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .poll-bar-fill {
            height: 100%;
            background-color: var(--poll-bar-fill);
            width: 0;
        }

        .poll-label {
            position: absolute;
            top: 0;
            left: 12px;
            line-height: 30px;
            font-size: 14px;
            font-weight: bold;
            color: var(--main-text);
        }

        .poll-percent {
            position: absolute;
            top: 0;
            right: 12px;
            line-height: 30px;
            font-size: 14px;
            font-weight: bold;
            color: var(--main-text);
        }

        /* アクション */
        .tweet-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            max-width: 425px;
        }

        .action-item {
            display: flex;
            align-items: center;
            color: var(--sub-text);
            font-size: 13px;
            transition: 0.2s;
            min-height: 20px;
        }

        .action-item svg {
            width: 18.75px;
            height: 18.75px;
            fill: currentColor;
            padding: 8px;
            border-radius: 50%;
            transition: 0.2s;
        }

        .action-count {
            padding: 0 4px;
            min-width: 20px;
        }

        .action-item.reply:hover {
            color: #1d9bf0;
        }

        .action-item.reply:hover svg {
            background-color: var(--action-hover-reply);
        }

        .action-item.repost:hover {
            color: #00ba7c;
        }

        .action-item.repost:hover svg {
            background-color: var(--action-hover-repost);
        }

        .action-item.like:hover {
            color: #f91880;
        }

        .action-item.like:hover svg {
            background-color: var(--action-hover-like);
        }

        .action-item.share:hover {
            color: #1d9bf0;
        }

        .action-item.share:hover svg {
            background-color: var(--action-hover-reply);
        }

        img.emoji {
            height: 1.2em;
            width: 1.2em;
            margin: 0 .05em 0 .1em;
            vertical-align: -0.2em;
        }

        .footer {
            padding: 30px;
            text-align: center;
            font-size: 13px;
            color: var(--sub-text);
            border-top: 1px solid var(--border-color);
        }

        .footer a {
            color: var(--sub-text);
            text-decoration: none;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
        }

        .footer a:hover {
            text-decoration: underline;
            color: var(--main-text);
        }

        .footer svg {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            fill: currentColor;
        }

        /* --- テーマ切り替えアイコンの制御 --- */
        /* デフォルト（ライトモード） */
        .icon-light {
            display: block;
        }

        .icon-dark {
            display: none;
        }

        /* ダークモード時 */
        [data-theme="dark"] .icon-light {
            display: none;
        }

        [data-theme="dark"] .icon-dark {
            display: block;
        }
    </style>
</head>

<body>

    <div class="app-layout">
        <nav class="sidebar">
            <div class="logo-container" onclick="window.location.reload(true);">
                <svg viewBox="0 0 24 24" class="logo">
                    <path
                        d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.593 1.85 2.313 3.198 4.352 3.234-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.062 1.323 4.51 2.093 7.14 2.093 8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602.91-.658 1.7-1.477 2.323-2.41z">
                    </path>
                </svg>
            </div>

            <div class="nav-item active" onclick="resetView()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 1.696L.622 8.807l1.06 1.696L3 9.679V19.5C3 20.881 4.119 22 5.5 22h13c1.381 0 2.5-1.119 2.5-2.5V9.679l1.318.824 1.06-1.696L12 1.696zM12 16.5c-1.933 0-3.5-1.567-3.5-3.5s1.567-3.5 3.5-3.5 3.5 1.567 3.5 3.5-1.567 3.5-3.5 3.5z"
                        fill="currentColor" />
                </svg>
                <span>ホーム</span>
            </div>

            <div class="nav-item" onclick="document.getElementById('fileInput').click()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"
                        fill="currentColor" />
                </svg>
                <span>ファイル</span>
            </div>

            <div class="nav-item" onclick="toggleTheme()">
                <svg class="theme-icon icon-light" width="24px" height="24px" viewBox="0 0 185.636 200">
                    <path fill="currentColor" d="M132.893,263.006A103.089,103.089,0,0,1,14.552,421.953,103.23,103.23,0,1,0,132.893,263.006ZM59.718,280.253,45.754,306.026l-28.8,5.475,20.2,21.243-3.692,29.079L59.908,349.18l26.515,12.5L82.571,332.62l20.08-21.357-28.828-5.314Z" transform="translate(-14.552 -263.006)"/>
                </svg>

                <svg class="theme-icon icon-dark" width="24px" height="24px" viewBox="0 0 200 200">
                    <path fill="currentColor" d="M95.783,198.255a5.964,5.964,0,0,1-1.75-4.3V168.069a5.967,5.967,0,1,1,11.935,0v25.882A5.968,5.968,0,0,1,100.088,200H100A5.969,5.969,0,0,1,95.783,198.255Zm66.425-27.6-18.3-18.3a5.967,5.967,0,1,1,8.438-8.438l18.3,18.3a5.967,5.967,0,1,1-8.438,8.438Zm-132.857.113a5.967,5.967,0,0,1,0-8.559l18.3-18.3a5.967,5.967,0,1,1,8.438,8.438l-18.3,18.3a5.967,5.967,0,0,1-8.434.121ZM54.131,100A45.869,45.869,0,1,1,100,145.869,45.869,45.869,0,0,1,54.131,100ZM162.1,100a5.967,5.967,0,0,1,5.968-5.967h25.882a5.968,5.968,0,1,1,0,11.934H168.069A5.968,5.968,0,0,1,162.1,100ZM6.05,105.966a5.967,5.967,0,1,1,0-11.933H31.932a5.967,5.967,0,1,1,0,11.935ZM143.914,56.094a5.966,5.966,0,0,1,0-8.438l18.3-18.3a5.967,5.967,0,1,1,8.438,8.438l-18.3,18.3a5.966,5.966,0,0,1-8.439,0Zm-96.258-.008-18.3-18.3a5.967,5.967,0,1,1,8.438-8.438l18.3,18.3a5.967,5.967,0,1,1-8.439,8.438ZM94.035,31.932V6.05q0-.039,0-.077a5.967,5.967,0,1,1,11.934,0q0,.038,0,.076V31.932a5.967,5.967,0,1,1-11.934,0Z" transform="translate(0 0)"/>
                </svg>

                <span>表示切り替え</span>
            </div>

            <div id="accountListSection" class="account-section"></div>
        </nav>

        <main class="main-content">
            <div id="uploadArea" class="upload-area">
                <h2 style="margin-bottom: 30px; color: var(--main-text);">アーカイブを表示</h2>
                <div class="file-upload" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <span style="font-weight: bold; color: var(--sub-text); font-size: 18px;">
                        JSONファイルをドロップ<br>
                        <span style="font-size: 14px; font-weight: normal;">またはクリックして選択</span>
                    </span>
                    <input type="file" id="fileInput" accept=".json" multiple>
                </div>
            </div>

            <div id="feedArea" style="display: none;">
                <div class="feed-header" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                    <div>
                        <h2 id="headerName">Name</h2>
                        <div class="feed-subtitle" id="headerCount">0 件のツイート</div>
                    </div>
                </div>

                <div class="profile-card">
                    <div class="profile-banner"></div>
                    <img id="profileIcon" src="" class="profile-avatar-large">
                    <div style="margin-bottom: 12px;">
                        <h2 style="font-size: 20px; font-weight: 800; margin: 0; color: var(--main-text);"
                            id="profileName">Name</h2>
                        <div style="color: var(--sub-text); font-size: 15px;" id="profileId">@id</div>
                    </div>
                <div class="profile-stats">
                    <span class="stat-item"><span class="stat-value" id="followingCount">0</span> フォロー中</span>
                    <span class="stat-item"><span class="stat-value" id="followersCount">0</span> フォロワー</span>
                </div>
                    <div style="font-size: 14px; color: var(--sub-text);">
                        <span id="profileDate"></span> 取得
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('posts')"><span class="tab-text">ツイート</span></div>
                    <div class="tab" onclick="switchTab('media')"><span class="tab-text">メディア</span></div>
                </div>

                <div id="timeline"></div>

                <div class="footer">
                    <span>&copy; 2025 szkta.com</span>
                    <a href="https://github.com/szkta/nonoha" target="_blank" rel="noopener noreferrer">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                        </svg>
                        GitHub
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');

        const loadedData = {};
        let currentUserId = null;
        let currentTab = 'posts';

        // テーマ切り替え機能
        function toggleTheme() {
            // 現在の設定を取得
            const isDark = document.body.dataset.theme === 'dark';
            if (isDark) {
                // ライトモードへ（属性削除）
                delete document.body.dataset.theme;
                localStorage.setItem('theme', 'light');
            } else {
                // ダークモードへ（属性付与）
                document.body.dataset.theme = 'dark';
                localStorage.setItem('theme', 'dark');
            }
        }

        // 初期ロード時にテーマを復元
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.dataset.theme = 'dark';
            }
        })();

        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#1d9bf0'; dropZone.style.backgroundColor = 'var(--drop-active)'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--border-color)'; dropZone.style.backgroundColor = 'var(--bg-color)'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border-color)';
            dropZone.style.backgroundColor = 'var(--bg-color)';
            if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        const targetUser = json.meta?.target || json.meta?.target_user || 'unknown';
                        loadedData[targetUser] = json;
                        updateSidebar();
                        if (!currentUserId) switchUser(targetUser);
                    } catch (err) {
                        console.error(err);
                        alert("読込失敗: " + file.name);
                    }
                };
                reader.readAsText(file);
            });
        }

        function updateSidebar() {
            const container = document.getElementById('accountListSection');
            container.innerHTML = '';
            Object.keys(loadedData).forEach(userId => {
                const data = loadedData[userId];
                const meta = data.meta || {};
                const history = meta.profile_history || [];
                const latest = history.length > 0 ? history[0] : { name: userId, screen_name: "@" + userId, avatar: "" };
                const avatar = latest.avatar ? latest.avatar.replace(/\\/g, '/') : 'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';

                const div = document.createElement('div');
                div.className = `account-item ${currentUserId === userId ? 'active' : ''}`;
                div.onclick = () => switchUser(userId);
                div.innerHTML = `<img src="${avatar}" class="account-icon"><div class="account-info"><span class="account-name">${latest.name}</span><span class="account-id">${latest.screen_name}</span></div>`;
                container.appendChild(div);
            });
        }

        function switchUser(userId) {
            currentUserId = userId;
            updateSidebar();
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('feedArea').style.display = 'block';
            renderHeader(userId);
            renderTimeline(userId);
            window.scrollTo(0, 0);
        }

        function resetView() {
            currentUserId = null;
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('feedArea').style.display = 'none';
            updateSidebar();
        }

        function renderHeader(userId) {
            const data = loadedData[userId];
            const meta = data.meta || {};
            const history = meta.profile_history || [];
            // 最新プロフィール
            const latest = history.length > 0 ? history[0] : { name: userId, screen_name: "@" + userId, avatar: "" };
            const avatar = latest.avatar ? latest.avatar.replace(/\\/g, '/') : 'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';
            const dateStr = meta.last_updated || meta.execution_date;
            const dateDisplay = dateStr ? new Date(dateStr).toLocaleString('ja-JP') : '不明';

            // ユーザー情報（JSから取得したuser_infoがあればそれを使う）
            const userInfo = meta.user_info || {};
            const following = userInfo.following || "-";
            const followers = userInfo.followers || "-";

            document.getElementById('headerName').innerText = latest.name;
            document.getElementById('headerCount').innerText = `${meta.total_posts_retrieved || 0} 件のツイート`;
            document.getElementById('profileIcon').src = avatar;
            document.getElementById('profileName').innerText = latest.name;
            document.getElementById('profileId').innerText = latest.screen_name;
            document.getElementById('profileDate').innerText = dateDisplay;

            // フォロー数・フォロワー数反映
            document.getElementById('followingCount').innerText = following;
            document.getElementById('followersCount').innerText = followers;
        }

        window.switchTab = function (type) {
            currentTab = type;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${type === 'posts' ? 1 : 2})`).classList.add('active');
            renderTimeline(currentUserId);
        };

        function extractNumber(str) {
            if (!str) return '0';
            const match = str.toString().match(/([\d,.]+[KMGT万億]?)/);
            return match ? match[1] : '0';
        }

        function renderTimeline(userId) {
            const data = loadedData[userId];
            if (!data) return;
            const container = document.getElementById('timeline');
            container.innerHTML = '';

            const posts = data.posts || [];
            const filteredPosts = currentTab === 'media' ? posts.filter(p => p.images && p.images.length > 0) : posts;

            const history = data.meta.profile_history || [];
            const latest = history.length > 0 ? history[0] : { name: userId, screen_name: "@" + userId };
            const avatar = latest.avatar ? latest.avatar.replace(/\\/g, '/') : 'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';

            if (filteredPosts.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--sub-text);">表示するツイートがありません</div>';
                return;
            }

            filteredPosts.forEach(post => {
                let mediaHtml = '';
                if (post.images && post.images.length > 0) {
                    let gridClass = `cols-${Math.min(post.images.length, 4)}`;
                    mediaHtml = `<div class="media-grid ${gridClass}">`;
                    post.images.forEach(media => {
                        const path = media.replace(/\\/g, '/');
                        if (path.endsWith('.mp4')) mediaHtml += `<video src="${path}" autoplay loop muted playsinline controls></video>`;
                        else mediaHtml += `<a href="${path}" target="_blank"><img src="${path}" loading="lazy"></a>`;
                    });
                    mediaHtml += `</div>`;
                }

                let pollHtml = '';
                if (post.poll) {
                    const total = post.poll.total_votes || 0;
                    let optionsHtml = '';
                    (post.poll.options || []).forEach(opt => {
                        const votes = Math.round(total * (opt.percent / 100));
                        optionsHtml += `
                        <div class="poll-option" title="推定投票数: ${votes}票">
                            <div class="poll-bar-bg"><div class="poll-bar-fill" style="width:${opt.percent}%"></div>
                            <span class="poll-label">${opt.label}</span><span class="poll-percent">${opt.percent}%</span></div>
                        </div>`;
                    });
                    pollHtml = `<div class="poll-container">${optionsHtml}<div style="font-size:13px; color:var(--sub-text); margin-top:5px;">${total.toLocaleString()}票</div></div>`;
                }

                const m = post.metrics || {};
                const replyCount = extractNumber(m.reply);
                const repostCount = extractNumber(m.repost);
                const likeCount = extractNumber(m.like);

                let postDate = '';
                try { if (post.date) postDate = new Date(post.date).toLocaleString('ja-JP', { month: 'short', day: 'numeric' }); } catch (e) { }

                const article = document.createElement('article');
                article.className = 'tweet';
                article.onclick = (e) => {
                    if (e.target.tagName !== 'A' && e.target.tagName !== 'IMG' && e.target.tagName !== 'VIDEO') {
                        window.open(post.url, '_blank');
                    }
                };

                article.innerHTML = `
                <div class="tweet-avatar">
                    <img src="${avatar}" loading="lazy">
                </div>
                <div class="tweet-content">
                    <div class="tweet-header">
                        <span class="user-name-bold">${latest.name}</span>
                        <span class="user-id-gray">${latest.screen_name}</span>
                        <span class="dot-separator">·</span>
                        <a href="${post.url}" target="_blank" class="tweet-date">${postDate}</a>
                    </div>
                    <div class="tweet-text">${post.text}</div>
                    ${mediaHtml}
                    ${pollHtml}
                    <div class="tweet-actions">
                        <div class="action-item reply"><svg viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></svg><span class="action-count">${replyCount}</span></div>
                        <div class="action-item repost"><svg viewBox="0 0 24 24"><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg><span class="action-count">${repostCount}</span></div>
                        <div class="action-item like"><svg viewBox="0 0 24 24"><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></svg><span class="action-count">${likeCount}</span></div>
                        <div class="action-item share"><svg viewBox="0 0 24 24"><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></svg></div>
                    </div>
                </div>
            `;
                container.appendChild(article);
            });

            twemoji.parse(document.body);
        }
    </script>

</body>

</html>